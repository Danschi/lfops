- block:

  - name: mkdir /etc/duplicity
    ansible.builtin.file:
      path: '/etc/duplicity'
      state: 'directory'
      owner: 'root'
      group: 'root'
      mode: 0755

  - name: 'Create /var/log/duplicity'
    ansible.builtin.file:
      path: '/var/log/duplicity'
      state: 'directory'

  tags:
    - 'duplicity'


- block:

  - name: 'Generate gpg key'
    linuxfabrik.lfops.gpg_key:
      name_real: 'duplicity'
      name_email: '{{ ansible_facts["user_id"] }}@{{ ansible_facts["nodename"] }}'
      key_type: 'RSA'
      key_length: 4096
      passphrase: '{{ duplicity__gpg_passphrase }}'
      subkey_type: 'RSA'
      subkey_length: 4096
    register: duplicity__gpg_key


  - block:

    - name: 'Create temporary directory for the gpg keys'
      ansible.builtin.tempfile:
        state: 'directory'
        suffix: '{{ ansible_facts["nodename"] }}-gpg-keys'
      delegate_to: 'localhost'
      changed_when: false
      register: duplicity__tempdir

    - name: 'Save the private key to the temporary directory'
      ansible.builtin.copy:
        dest: '{{ duplicity__tempdir["path"] }}/private-key'
        content: '{{ duplicity__gpg_key["ascii_armored_private_key"] }}'
        mode: 0600
      changed_when: false
      delegate_to: 'localhost'

    - name: 'Save the public key to the temporary directory'
      ansible.builtin.copy:
        dest: '{{ duplicity__tempdir["path"] }}/public-key'
        content: '{{ duplicity__gpg_key["ascii_armored_public_key"] }}'
        mode: 0600
      changed_when: false
      delegate_to: 'localhost'

    - name: 'Save the gpg keys in bitwarden'
      linuxfabrik.lfops.bitwarden_item:
        hostname: '{{ ansible_facts["nodename"] }}'
        purpose: 'duplicity GPG Keys'
        attachments:
          - '{{ duplicity__tempdir["path"] }}/private-key'
          - '{{ duplicity__tempdir["path"] }}/public-key'
        collection_id: '{{ bitwarden__collection_id | default(omit) }}'
        organization_id: '{{ bitwarden__organization_id | default(omit) }}'
      delegate_to: 'localhost'

    - name: 'Delete temporary directory'
      ansible.builtin.file:
        path: '{{ duplicity__tempdir["path"] }}'
        state: 'absent'
      changed_when: false

    # block
    when: 'duplicity__save_gpg_keys_to_bitwarden and not ansible_check_mode'


  - name: 'Deploy /etc/duplicity/duplicity.conf'
    ansible.builtin.template:
      src: 'etc/duplicity/duplicity.conf.j2'
      dest: '/etc/duplicity/duplicity.conf'
      mode: 0600 # file contains secrets

  - name: 'Deploy /usr/local/bin/duplicity-backup'
    ansible.builtin.template:
      src: 'usr/local/bin/duplicity-backup.j2'
      dest: '/usr/local/bin/duplicity-backup'
      owner: 'root'
      mode: 0755

  - name: 'Deploy /etc/logrotate.d/duplicity'
    ansible.builtin.template:
      src: 'etc/logrotate.d/duplicity.j2'
      dest: '/etc/logrotate.d/duplicity'
      owner: 'root'
      mode: 0644

  - name: 'Deploy /etc/systemd/system/duplicity-backup.service'
    ansible.builtin.template:
      src: 'etc/systemd/system/duplicity-backup.service.j2'
      dest: '/etc/systemd/system/duplicity-backup.service'
      owner: 'root'
      group: 'root'
      mode: 0644

  - name: 'Deploy /etc/systemd/system/duplicity-backup.timer'
    ansible.builtin.template:
      src: 'etc/systemd/system/duplicity-backup.timer.j2'
      dest: '/etc/systemd/system/duplicity-backup.timer'
      owner: 'root'
      group: 'root'
      mode: 0644

  tags:
    - 'duplicity'
    - 'duplicity:configure'


- block:

  - name: 'systemctl {{ duplicity__timer_enabled | bool | ternary("enable", "disable") }} duplicity-backup.timer --now'
    ansible.builtin.systemd:
        name: 'duplicity-backup.timer'
        state: '{{ duplicity__timer_enabled | bool | ternary("started", "stopped") }}'
        enabled: '{{ duplicity__timer_enabled }}'
        daemon_reload: true

  tags:
    - 'duplicity'
    - 'duplicity:state'
