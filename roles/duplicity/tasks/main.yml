- block:

  - name: mkdir /etc/duplicity
    ansible.builtin.file:
      path: '/etc/duplicity'
      state: 'directory'
      owner: 'root'
      group: 'root'
      mode: 0755

  tags:
    - 'duplicity'


- block:

  - name: 'Generate gpg key'
    linuxfabrik.lfops.gpg_key:
      name_real: 'duplicity'
      name_email: '{{ ansible_facts["user_id"] }}@{{ ansible_facts["nodename"] }}'
      key_type: 'RSA'
      key_length: 4096
    register: duplicity__gpg_key

  - name: 'Deploy the public master GPG key to /tmp/public-master-key'
    ansible.builtin.copy:
      dest: '/tmp/public-master-key'
      content: '{{ duplicity__public_master_key }}'
      mode: 0600
    changed_when: false

  - name: 'gpg --import /tmp/public-master-key'
    ansible.builtin.command: 'gpg --import /tmp/public-master-key'
    register: 'duplicity__gpg_import_result'
    changed_when: '"not changed" not in duplicity__gpg_import_result.stderr'

  - name: 'gpg --import /tmp/public-master-key'
    ansible.builtin.command: 'gpg --import /tmp/public-master-key'
    register: 'duplicity__gpg_import_result'
    changed_when: '"not changed" not in duplicity__gpg_import_result.stderr'

  - name: 'rm -f /tmp/public-master-key'
    ansible.builtin.file:
      path: '/tmp/public-master-key'
      state: 'absent'
    changed_when: false

  - name: "echo '{{ duplicity__public_master_long_keyid }}:6:' | gpg --import-ownertrust # set trust to ultimate"
    ansible.builtin.shell: "echo '{{ duplicity__public_master_long_keyid }}:6:' | gpg --import-ownertrust"
    register: 'duplicity__gpg_import_ownertrust_result'
    changed_when: '"ownertrust" in duplicity__gpg_import_ownertrust_result.stderr'

  - name: 'Deploy /etc/duplicity/duplicity.conf'
    ansible.builtin.template:
      src: 'etc/duplicity/duplicity.conf.j2'
      dest: '/etc/duplicity/duplicity.conf'
      mode: 0600 # file contains secrets

  - name: 'Deploy /usr/local/bin/duplicity-backup'
    ansible.builtin.template:
      src: 'usr/local/bin/duplicity-backup.j2'
      dest: '/usr/local/bin/duplicity-backup'
      owner: 'root'
      mode: 0755

  - name: 'Deploy /etc/logrotate.d/duplicity'
    ansible.builtin.template:
      src: 'etc/logrotate.d/duplicity.j2'
      dest: '/etc/logrotate.d/duplicity'
      owner: 'root'
      mode: 0644

  - name: 'Deploy /etc/systemd/system/duplicity-backup.service'
    ansible.builtin.template:
      src: 'etc/systemd/system/duplicity-backup.service.j2'
      dest: '/etc/systemd/system/duplicity-backup.service'
      owner: 'root'
      group: 'root'
      mode: 0644

  - name: 'Deploy /etc/systemd/system/duplicity-backup.timer'
    ansible.builtin.template:
      src: 'etc/systemd/system/duplicity-backup.timer.j2'
      dest: '/etc/systemd/system/duplicity-backup.timer'
      owner: 'root'
      group: 'root'
      mode: 0644

  tags:
    - 'duplicity'
    - 'duplicity:configure'


- block:

  - name: 'systemctl {{ duplicity__timer_enabled | bool | ternary("enable", "disable") }} duplicity-backup.timer --now'
    ansible.builtin.systemd:
        name: 'duplicity-backup.timer'
        state: '{{ duplicity__timer_enabled | bool | ternary("started", "stopped") }}'
        enabled: '{{ duplicity__timer_enabled }}'
        daemon_reload: true

  tags:
    - 'duplicity'
    - 'duplicity:state'
