- block:

  - name: 'Install libreoffice-core'
    ansible.builtin.package:
      name:
        - 'libreoffice-core'
      state: 'present'

  tags:
    - 'libreoffice'


- block:

  - name: 'mkdir -p /usr/share/httpd/.config/libreoffice'
    ansible.builtin.file:
      path: '/usr/share/httpd/.config/libreoffice'
      state: 'directory'

  - name: 'chown -R apache:apache /usr/share/httpd/.config'
    ansible.builtin.file:
      path: '/usr/share/httpd/.config'
      owner: 'apache'
      group: 'apache'
      mode: 0o755

  - name: 'mkdir -p /usr/share/httpd/.cache'
    ansible.builtin.file:
      path: '/usr/share/httpd/.cache'
      state: 'directory'
      owner: 'apache'
      group: 'apache'
      mode: 0o755

  - name: 'Run LibreOffice under user "apache" once, just to create some subdirectories and files'
    ansible.builtin.command: |-
      /usr/bin/soffice --headless --convert-to pdf myfile
    args:
      creates: '/usr/share/httpd/.config/libreoffice/4'
    become: true
    become_method: 'su'
    become_user: 'apache'
    become_flags: '-s /bin/bash'  # do something as the apache user when the shell is nologin
    ignore_errors: true

  # - name: 'restorecon -Fvr /var/www/html/matomo'
  #   ansible.builtin.command: 'restorecon -Fvr /var/www/html/matomo'
  #   register: 'matomo__restorecon_result'
  #   changed_when: 'matomo__restorecon_result["stdout"] | length'

  when:
    - 'libreoffice__client_apache is defined'
    - 'libreoffice__client_apache'
  tags:
    - 'libreoffice'
