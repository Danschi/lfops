# {{ ansible_managed }}
# 2022082201
# Reverse Proxy vHost
{% if item.by_role | d() %}
# Generated by Ansible role: {{ item.by_role }}
{% endif %}

# {{ item.comment | d('no description available') }}
<VirtualHost {{ item.virtualhost_ip | d('*') }}:{{ item.virtualhost_port | d(443) }}>
    ServerName {{ item.conf_server_name }}
{% if item.conf_server_alias is defined and item.conf_server_alias|length %}
    ServerAlias {{ item.conf_server_alias }}
{% endif %}
    ServerAdmin {{ item.conf_server_admin | d(apache_httpd__conf_server_admin) }}

    ErrorLog "{{ item.conf_error_log | d('logs/' + item.conf_server_name + '-error.log')}}"
    LogLevel {{ item.conf_log_level | d('notice core:info') }}
{% if item.conf_custom_log is defined and item.conf_custom_log %}
    # log_config_module
    CustomLog {{ item.conf_custom_log }}
{% endif %}

    KeepAliveTimeout {{ item.conf_keep_alive_timeout | d(5) }}
    Timeout {{ item.conf_timeout | d(apache_httpd__conf_timeout) }}

    # proxy_module
    ProxyErrorOverride {{ item.ProxyErrorOverride | d('On') }}
    {% if item.ProxyPreserveHost is defined %}
    ProxyPreserveHost {{ item.ProxyPreserveHost | d('Off') }}
    {% endif %}
    ProxyRequests Off
    ProxyTimeout {{ item.ProxyTimeout | d(5) }}

    # reqtimeout_module
    # set timeout values for receiving the request headers and/or body from client
    RequestReadTimeout {{ item.conf_request_read_timeout | d('header=20-40,MinRate=500 body=20,MinRate=500') }}

    # rewrite_module
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} !^({{ item.allowed_http_methods | d(['GET','OPTIONS']) | join('|') }})
    RewriteRule .* - [redirect=405,last]

    # disable old HTTP protocol versions
    # just allow those ones listed below
    RewriteCond %{THE_REQUEST} !HTTP/1\.1$
    RewriteCond %{THE_REQUEST} !HTTP/2
    RewriteCond %{THE_REQUEST} !HTTP/3
    RewriteRule .* - [forbidden]

    # requests without a hostname are disallowed
    RewriteCond %{HTTP_HOST} !^{{ item.conf_server_name|replace('.', '\.') }} [nocase]
    RewriteCond %{REQUEST_URI} !^/error [nocase]
    RewriteRule ^.(.*) - [last,forbidden]

{% if item.raw | d() %}
# raw content
{{ item.raw }}
{% endif %}
</VirtualHost>
