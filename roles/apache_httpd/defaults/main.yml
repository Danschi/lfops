apache_httpd__skip_php_fpm: false

apache_httpd__systemd_enabled: true
apache_httpd__systemd_state: 'started'


# Apache Module Installation
# --------------------------

apache_httpd__packages__role_var:
  mod_qos:
    state: 'present'

  mod_security:
    state: 'present'

  mod_ssl:
    state: 'present'

apache_httpd__packages__dependent_var: {}
apache_httpd__packages__group_var: {}
apache_httpd__packages__host_var: {}
apache_httpd__packages__combined_var: '{{ apache_httpd__packages__role_var
    | combine(apache_httpd__packages__dependent_var)
    | combine(apache_httpd__packages__group_var)
    | combine(apache_httpd__packages__host_var)
  }}'

# for mod_security - normally nothing that you have to change
# get details from https://coreruleset.org/installation/
# origin: https://github.com/coreruleset/coreruleset/archive/v3.3.2.tar.gz
apache_httpd__mod_security_coreruleset_url: 'https://github.com/coreruleset/coreruleset/archive'
apache_httpd__mod_security_coreruleset_version: '3.3.2'
apache_httpd__mod_security_coreruleset_checksum: 'sha1:63aa8ee3f3c9cb23f5639dd235bac1fa1bc64264'


# Apache Module Configuration
# ---------------------------

# Apache mods managed by this Ansible role.
apache_httpd__mods__role_var:
  alias:
    enabled: true
    state: 'present'
    template: 'alias'

  authn_core:
    enabled: true
    state: 'present'
    template: 'authn_core'

  authn_file:
    enabled: true
    state: 'present'
    template: 'authn_file'

  authz_core:
    enabled: true
    state: 'present'
    template: 'authz_core'

  authz_host:
    enabled: true
    state: 'present'
    template: 'authz_host'

  authz_user:
    enabled: true
    state: 'present'
    template: 'authz_user'

  cgi:
    enabled: false
    state: 'present'
    template: 'cgi'

  cgid:
    enabled: false
    state: 'present'
    template: 'cgid'

  deflate:
    enabled: false
    state: 'present'
    template: 'deflate'

  dir:
    enabled: true
    state: 'present'
    template: 'dir'

  filter:
    enabled: false
    state: 'present'
    template: 'filter'

  expires:
    enabled: true
    state: 'present'
    template: 'expires'

  headers:
    enabled: true
    state: 'present'
    template: 'headers'

  http2:
    enabled: false
    state: 'present'
    template: 'http2'

  info:
    enabled: true
    state: 'present'
    template: 'info'

  log_config:
    enabled: true
    state: 'present'
    template: 'log_config'

  logio:
    enabled: true
    state: 'present'
    template: 'logio'

  maxminddb:
    enabled: false
    state: 'present'
    template: 'maxminddb'

  mime:
    enabled: true
    state: 'present'
    template: 'mime'

  mime_magic:
    enabled: true
    state: 'present'
    template: 'mime_magic'

  mpm_event:
    enabled: true
    state: 'present'
    template: 'mpm_event'

  mpm_prefork:
    enabled: false
    state: 'present'
    template: 'mpm_prefork'

  mpm_worker:
    enabled: false
    state: 'present'
    template: 'mpm_worker'

  php7:
    enabled: false
    state: 'present'
    template: 'php7'

  php8:
    enabled: false
    state: 'present'
    template: 'php8'

  proxy:
    enabled: true
    state: 'present'
    template: 'proxy'

  proxy_fcgi:
    enabled: false
    state: 'present'
    template: 'proxy_fcgi'

  proxy_http:
    enabled: false
    state: 'present'
    template: 'proxy_http'

  proxy_wstunnel:
    enabled: false
    state: 'present'
    template: 'proxy_wstunnel'

  qos:
    enabled: true
    state: 'present'
    template: 'qos'

  reqtimeout:
    enabled: true
    state: 'present'
    template: 'reqtimeout'

  rewrite:
    enabled: true
    state: 'present'
    template: 'rewrite'

  security2:
    enabled: false
    state: 'present'
    template: 'security2'

  setenvif:
    enabled: true
    state: 'present'
    template: 'setenvif'

  slotmem_shm:
    enabled: true
    state: 'present'
    template: 'slotmem_shm'

  socache_shmcb:
    enabled: true
    state: 'present'
    template: 'socache_shmcb'

  ssl:
    enabled: true
    state: 'present'
    template: 'ssl'

  status:
    enabled: true
    state: 'present'
    template: 'status'

  systemd:
    enabled: true
    state: 'present'
    template: 'systemd'

  unique_id:
    enabled: true
    state: 'present'
    template: 'unique_id'

  unix:
    enabled: true
    state: 'present'
    template: 'unix'

  wsgi_python3:
    enabled: false
    state: 'present'
    template: 'wsgi_python3'

apache_httpd__mods__dependent_var: {}
apache_httpd__mods__group_var: {}
apache_httpd__mods__host_var: {}
apache_httpd__mods__combined_var: '{{ apache_httpd__mods__role_var
    | combine(apache_httpd__mods__dependent_var)
    | combine(apache_httpd__mods__group_var)
    | combine(apache_httpd__mods__host_var)
  }}'


# Apache "conf-available"
# -----------------------

# Apache conf used internally by this role.
apache_httpd__conf__role_var:
  deflate:
    enabled: true
    state: 'present'
    template: 'deflate'

  dir:
    enabled: true
    state: 'present'
    template: 'dir'

  expires:
    enabled: true
    state: 'present'
    template: 'expires'

  headers:
    enabled: true
    state: 'present'
    template: 'headers'

  http2:
    enabled: true
    state: 'present'
    template: 'http2'

  log_config:
    enabled: true
    state: 'present'
    template: 'log_config'

  logio:
    enabled: true
    state: 'present'
    template: 'logio'

  mime:
    enabled: true
    state: 'present'
    template: 'mime'

  mime_magic:
    enabled: true
    state: 'present'
    template: 'mime_magic'

  mod_security:
    enabled: true
    state: 'present'
    template: 'mod_security'

  mpm_event:
    enabled: true
    state: 'present'
    template: 'mpm_event'

  mpm_prefork:
    enabled: false
    state: 'present'
    template: 'mpm_prefork'

  mpm_worker:
    enabled: false
    state: 'present'
    template: 'mpm_worker'

  php:
    enabled: false
    state: 'present'
    template: 'php'

  python:
    enabled: false
    state: 'present'
    template: 'python'

  ssl:
    enabled: true
    state: 'present'
    template: 'ssl'

  status:
    enabled: false
    state: 'present'
    template: 'status'

  unixd:
    enabled: true
    state: 'present'
    template: 'unixd'

apache_httpd__conf__dependent_var: {}
apache_httpd__conf__group_var: {}
apache_httpd__conf__host_var: {}
apache_httpd__conf__combined_var: '{{ apache_httpd__conf__role_var
    | combine(apache_httpd__conf__dependent_var)
    | combine(apache_httpd__conf__group_var)
    | combine(apache_httpd__conf__host_var)
  }}'


# Apache Global Config
# --------------------

# core
apache_httpd__conf_add_default_charset: 'UTF-8'
apache_httpd__conf_document_root: '/var/www/html'
apache_httpd__conf_enable_send_file: 'On'
apache_httpd__conf_error_log: 'syslog:local1'
apache_httpd__conf_hostname_lookups: 'Off'
apache_httpd__conf_keep_alive: 'On'
apache_httpd__conf_keep_alive_timeout: 5
apache_httpd__conf_limit_request_body: 102400
apache_httpd__conf_limit_request_fields: 100
apache_httpd__conf_limit_request_field_size: 8190 # deviating from CIS value (1024), as this is a problem with any modern application which sets cookies in its Header
apache_httpd__conf_limit_request_line: 8190 # deviating from CIS value (512)
apache_httpd__conf_listen:
  - 80
apache_httpd__conf_log_level: 'warn'
apache_httpd__conf_max_keep_alive_requests: 500
apache_httpd__conf_server_name: 'localhost'
apache_httpd__conf_timeout: 10
apache_httpd__conf_trace_enable: 'Off'

# mod_dir
apache_httpd__conf_directory_index: 'index.html index.htm index.txt'

# mod_log_config
apache_httpd__conf_custom_log: 'logs/access.log combined'


# Apache Module Config
# --------------------

apache_httpd__conf_mpm_event_max_connections_per_child: 0
apache_httpd__conf_mpm_event_max_request_workers: 400
apache_httpd__conf_mpm_event_max_spare_threads: 250
apache_httpd__conf_mpm_event_min_spare_threads: 75
apache_httpd__conf_mpm_event_start_servers: 3
apache_httpd__conf_mpm_event_thread_limit: 64
apache_httpd__conf_mpm_event_threads_per_child: 25

apache_httpd__conf_mpm_prefork_max_connections_per_child: 0
apache_httpd__conf_mpm_prefork_max_request_workers: 256
apache_httpd__conf_mpm_prefork_max_spare_servers: 10
apache_httpd__conf_mpm_prefork_min_spare_servers: 5
apache_httpd__conf_mpm_prefork_start_servers: 5

apache_httpd__conf_mpm_worker_max_connections_per_child: 0
apache_httpd__conf_mpm_worker_max_request_workers: 400
apache_httpd__conf_mpm_worker_max_spare_threads: 250
apache_httpd__conf_mpm_worker_min_spare_threads: 75
apache_httpd__conf_mpm_worker_start_servers: 3
apache_httpd__conf_mpm_worker_thread_limit: 64
apache_httpd__conf_mpm_worker_threads_per_child: 25


# Apache Virtual Host Configuration
# ---------------------------------

# Used internally by this role. Order is important.
apache_httpd__vhosts__role_var:

  000-localhost_80: # the key is only used for overwriting earlier objects, nothing else
    comment: |-
      Host for internal things like monitoring, just accessible from localhost.
    enabled: true
    filename: '000-localhost.80'
    state: 'present'
    template: 'localhost'
    virtualhost_ip: '*'
    virtualhost_port: 80

    allowed_file_extensions:
      - 'html?'
      - 'php'
    allowed_http_methods:
      - 'GET'
      - 'OPTIONS'

    conf_custom_log: 'logs/localhost-access.log combined'
    conf_error_log: 'syslog:local1'
    conf_keep_alive_timeout: 5
    conf_log_level: 'notice core:info'
    conf_request_read_timeout: 'header=20-40,MinRate=500 body=20,MinRate=500'
    conf_server_name: 'localhost'

    raw: |-
      # headers_module
      Header always set Content-Security-Policy: "\
          default-src 'none'; \
          base-uri 'none'; \
          block-all-mixed-content; \
          child-src 'none'; \
          connect-src 'none'; \
          font-src 'none'; \
          form-action 'none'; \
          frame-ancestors 'none'; \
          frame-src 'none'; \
          img-src 'none'; \
          manifest-src 'none'; \
          media-src 'none'; \
          object-src 'none'; \
          prefetch-src 'none'; \
          require-trusted-types-for 'script'; \
          sandbox; \
          script-src 'none'; \
          style-src 'none'; \
          worker-src 'none'; \
          "
      Header always set Permissions-Policy: "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
      Header always set Referrer-Policy: "strict-origin-when-cross-origin"
      Header always set X-Content-Type-Options: "nosniff"
      Header always set X-XSS-Protection: "1; mode=block"


apache_httpd__vhosts__dependent_var: {}
apache_httpd__vhosts__group_var: {}
apache_httpd__vhosts__host_var: {}
apache_httpd__vhosts__combined_var: '{{ apache_httpd__vhosts__role_var
    | combine(apache_httpd__vhosts__dependent_var)
    | combine(apache_httpd__vhosts__group_var)
    | combine(apache_httpd__vhosts__host_var)
  }}'
