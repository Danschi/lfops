# yamllint disable rule:braces
# yamllint disable rule:commas

nextcloud__appconfig:
  - { key: 'core',              value: 'shareapi_default_expire_date --value=yes' }
  - { key: 'core',              value: 'shareapi_enforce_expire_date --value=no' }
  - { key: 'core',              value: 'shareapi_expire_after_n_days --value=90' }
  - { key: 'dav',               value: 'buildCalendarSearchIndex --value=yes' }
  - { key: 'password_policy',   value: 'enforceHaveIBeenPwned --value=1' }
  - { key: 'password_policy',   value: 'minLength --value=12' }
  - { key: 'privacy',           value: 'readableLocation --value="ch"' }
  - { key: 'theming',           value: 'imprintUrl --value=https://www.linuxfabrik.ch/ueber-uns/agb/' }
  - { key: 'theming',           value: 'name --value="Nextcloud for Teams"' }
  - { key: 'theming',           value: 'privacyUrl --value=https://www.linuxfabrik.ch/ueber-uns/agb/datenschutzerklaerung/' }
  - { key: 'theming',           value: 'slogan --value="powered by Linuxfabrik GmbH, ZÃ¼rich"' }
  - { key: 'theming',           value: 'url --value=https:\/\/ws.linuxfabrik.ch' }

nextcloud__datadir: '/data'

nextcloud__database: 'nextcloud'

nextcloud__mariadb_login: '{{ mariadb_server__admin_user }}'

nextcloud__on_calendar_app_update: '06,18,23:{{ 59 | random(seed=inventory_hostname) }}'
nextcloud__on_calendar_jobs: '*:0/5'   # Background jobs: every 5 minutes

# if running behind a reverse proxy, otherwise unset this
# the ip addresses are those of the reverse proxy
nextcloud__proxyconfig: []
# nextcloud__proxyconfig:
#   - { key: 'overwrite.cli.url', value: '--value=https://cloud.example.com' }
#   - { key: 'overwritecondaddr', value: '--value=^192\\.0\\.2\\.7$' }
#   - { key: 'overwritehost',     value: '--value=cloud.example.com' }
#   - { key: 'overwriteprotocol', value: '--value=https' }
#   - { key: 'overwritewebroot',  value: '--value=/' }
#   - { key: 'trusted_proxies',   value: '0 --value=192.0.2.7' }

# order matters here, so do not sort alphabetically
nextcloud__sysconfig:
  - { key: 'check_for_working_wellknown_setup',  value: '--value=false --type=boolean' }
  - { key: 'datadirectory',                      value: '--value={{ nextcloud__datadir }}' }
  - { key: 'default_language',                   value: '--value=en' }
  - { key: 'default_phone_region',               value: '--value=CH' }
  - { key: 'log_rotate_size',                    value: '--value=10485760 --type=integer' }
  - { key: 'loglevel',                           value: '--value=2 --type=integer' }
  - { key: 'logtimezone',                        value: '--value=Europe/Zurich' }
  - { key: 'trusted_domains',                    value: "1 --value={{ ansible_facts['default_ipv4']['address'] }}" }
  - { key: 'trusted_domains',                    value: "2 --value={{ nextcloud__fqdn }}" }
  - { key: 'updatechecker',                      value: '--value=false --type=boolean' }
  - { key: 'redis',                              value: 'dbindex --value=0 --type=integer' }
  - { key: 'redis',                              value: 'host --value=127.0.0.1' }
  - { key: 'redis',                              value: 'port --value=6379 --type=integer' }
  - { key: 'redis',                              value: 'timeout --value=0.5 --type=integer' }
  - { key: 'memcache.local',                     value: '--value=\\OC\\Memcache\\Redis' }
  - { key: 'memcache.distributed',               value: '--value=\\OC\\Memcache\\Redis' }
  - { key: 'memcache.locking',                   value: '--value=\\OC\\Memcache\\Redis' }
  - { key: 'filelocking.enabled',                value: '--value=true --type=boolean' }

nextcloud__timer_jobs_enabled: true
nextcloud__timer_app_update_enabled: true

# 'latest-XX' or 'nextcloud-XX.X.XX'
nextcloud__version: 'latest-24'

# -----------------------------------------------------------------------------

nextcloud__apache_httpd__vhosts__dependent_var:
  - by_role: 'nextcloud'
    enabled: true
    filename: 'nextcloud'
    state: 'present'
    type: 'app'

    allowed_file_extensions:
      # TODO: Test if any file upload is possible
      - 'css'
      - 'gif'
      - 'html?'
      - 'ico'
      - 'jpe?g'
      - 'js'
      - 'mp4'
      - 'pdf'
      - 'php'
      - 'png'
      - 'svg'
      - 'ttf'
      - 'txt'
      - 'woff2?'
    allowed_http_methods:
      - '.*'
    authz_file_extensions: |-
        Require all granted
    authz_document_root: |-
        Require all granted
    virtualhost_port: 80

    conf_custom_log_format: 'combined'
    conf_directory_index: 'index.php index.html index.htm'
    conf_document_root: '/var/www/html/nextcloud'
    conf_server_admin: 'webmaster@linuxfabrik.ch'
    conf_server_name: '{{ nextcloud__fqdn }}'
    conf_timeout: 600

    raw: !unsafe |-
      <IfModule mod_dav.c>
          Dav off
      </IfModule>


netcloud__collabora_code__coolwsd_storage_wopi__dependent_var:
  - '{{ nextcloud__fqdn | regex_replace("\.", "\.") }}'


nextcloud__kernel_settings__sysctl__dependent_var:
  # for MariaDB
  - name: 'vm.swappiness'
    value: 10
  # for Redis: WARNING overcommit_memory is set to 0! Background save may fail under low memory
  # condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then
  # reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.
  - name: 'vm.overcommit_memory'
    value: 1
  # for Redis: WARNING: The TCP backlog setting of 511 cannot be enforced because
  # /proc/sys/net/core/somaxconn is set to the lower value of 128.
  - name: 'net.core.somaxconn'
    value: 1024

nextcloud__kernel_settings__transparent_hugepages__dependent_var: 'madvise'

nextcloud__php__modules__dependent_var:
  - name: 'php-bcmath'
    state: 'present'
  - name: 'php-gd'
    state: 'present'
  - name: 'php-gmp'
    state: 'present'
  - name: 'php-imap'
    state: 'present'
  - name: 'php-imagick'
    state: 'present'
  - name: 'php-intl'
    state: 'present'
  - name: 'php-json'
    state: 'present'
  - name: 'php-ldap'
    state: 'present'
  - name: 'php-mbstring'
    state: 'present'
  - name: 'php-memcached'
    state: 'present'
  - name: 'php-mysqlnd'
    state: 'present'
  - name: 'php-opcache'
    state: 'present'
  - name: 'php-pecl-apcu'
    state: 'present'
  - name: 'php-process' # posix module for oc
    state: 'present'
  - name: 'php-redis'
    state: 'present'
  - name: 'php-smbclient'
    state: 'present'
  - name: 'php-zip'
    state: 'present'

nextcloud__php__ini_max_execution_time__dependent_var: 3600
nextcloud__php__ini_max_file_uploads__dependent_var: 100
nextcloud__php__ini_memory_limit__dependent_var: '1024M'
nextcloud__php__ini_post_max_size__dependent_var: '16M'
nextcloud__php__ini_upload_max_filesize__dependent_var: '10000M'
